<!DOCTYPE html>
<html>

<head>
    <title>Off the Beaten Path</title>

    <script src="https://kit.fontawesome.com/6969334fef.js" crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oleo+Script&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../static/style.css">
</head>

<body>
    <main>
        <h1 onclick="loadHomePage()">Off the Beaten Path</h1>

        <div class="part-1" id="partOne">
            <h2> Where do you want to go?</h2>

            <div id="countryChosen">
                <div class="country-box">
                    <h3 class="country-box-text" id="chosenCountry">Country Name</h3>
                </div>
                <button id="editCountry" class="country-icon">
                    <h3 id="countryPen"><i class="fa-solid fa-pen fa-2x"></i></h3>
                </button>
            </div>


            <div id="countryEditing" class="hidden">
                <form class="choose-form">
                    <div class="country-box">
                        <input list="datalist" id="country-input" type="text" onkeyup="ac(this.value)" />
                        <datalist id="datalist"></datalist>
                    </div>

                    <button id="chooseCountry" class="country-icon" type="submit">
                        <h3 id="countryCheck"><i class="fa-solid fa-check fa-3x"></i></h3>
                    </button>
                </form>
            </div>


            <button id="submitCountries">
                <!-- cant get fa badge check to work -->
                <h3><i class="fa-solid fa-check fa-3x"></i></h3>
            </button>
        </div>

        <div class="part-2 hidden" id="partTwo">
            <h2>What interests you?</h2>

            <form class="tags-form">
                <div class="tag-box" id="tagBox">
                    <div id=tags-checker></div>
                </div>

                <button id="submitTags" type="submit">
                    <!-- cant get fa badge check to work -->
                    <h3><i class="fa-solid fa-check fa-3x"></i></h3>
                </button>
            </form>
        </div>

        <div class="part-3 hidden" id="partThree">
            <h2>Your Suggested Paths</h2>

            <div id="outputBox"></div>
        </div>
    </main>
    <script>

        var editCountry = document.getElementById("editCountry");
        editCountry.onclick = function () {
            var countryEditView = document.getElementById("countryEditing");
            countryEditView.classList.remove("hidden");

            var countryChosenView = document.getElementById("countryChosen");
            countryChosenView.classList.add("hidden");
        }

        var countryInput = document.getElementById("country-input");
        document.querySelector('form.choose-form').addEventListener('submit', function (e) {
            e.preventDefault();

            var countryEditView = document.getElementById("countryEditing");
            countryEditView.classList.add("hidden");

            var countryChosenView = document.getElementById("countryChosen");
            countryChosenView.classList.remove("hidden");

            var newCountry = document.getElementById("chosenCountry");
            newCountry.innerHTML = countryInput.value;
        });

        var tags = []
        var tag_len = 0
        fetch("/country-list")
            .then((response) => response.json())
            .then((d) => {
                tags = d
                tag_len = tags.length;
            })


        function ac(value) {
            document.getElementById('datalist').innerHTML = '';

            l = value.length;
            for (var i = 0; i < tag_len; i++) {
                if (((tags[i].toLowerCase()).indexOf(value.toLowerCase())) > -1) {

                    var node = document.createElement("option");
                    var val = document.createTextNode(tags[i]);
                    node.appendChild(val);

                    document.getElementById("datalist").appendChild(node);
                }
            }
        }

        function tagBoxTemplate(tag) {
            return `<div class="tag">
                 <input class = "tags-input hidden" value =${tag} id="tags-input-${tag}" type="checkbox" /> <label for="tags-input-${tag}"> ${tag} </label>
            </div>`
        }

        function outputBoxTemplate(loc, count, url) {
            return `<a class='output-loc' target='_blank' href=${url}>${count}. ${loc}</a>`
        }

        var countriesSubmit = document.getElementById("submitCountries");
        countriesSubmit.onclick = function () {
            console.log(countryInput.value);

            document.getElementById("partTwo").classList.remove("hidden");

            fetch("/countries?" + new URLSearchParams({ countries: countryInput.value }).toString())
                .then((response) => response.json())
                .then((d) => {
                    d.forEach(tag => {
                        let tempDiv = document.createElement("div")
                        tempDiv.innerHTML = tagBoxTemplate(tag)
                        document.getElementById("tags-checker").appendChild(tempDiv)
                    })
                }
                );

            var tagsContainer = document.getElementById("tagBox");
            tagsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        var tagsInput = document.getElementsByClassName("tags-input");
        document.querySelector('form.tags-form').addEventListener('submit', function (e) {
            e.preventDefault();

            document.getElementById("partThree").classList.remove("hidden");

            var values = []
            for (const input of tagsInput) {
                if (input.checked) {
                    values.push(input.value)
                }
            }
            console.log(values)

            fetch("/output?" + new URLSearchParams({ tags: values }).toString())
                .then((response) => response.json())
                .then((list) => {
                    count = 1;

                    list.forEach((item) => {
                        let location =  item[0]
                        let url = item[1]
                        let tempDiv = document.createElement("div");
                        tempDiv.innerHTML = outputBoxTemplate(location, count, url);
                        document.getElementById("outputBox").appendChild(tempDiv)
                        count += 1;
                    });
                }
                );
            var outputContainer = document.getElementById("outputBox");
            outputContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

        });

        function loadHomePage() {
            window.location.href = "/";
          }

    </script>
</body>

</html>